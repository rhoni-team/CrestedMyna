{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'mapping/css/leaflet/leaflet.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

{% endblock %}

<div class="container p-3">
    <div id="global-map" class="global-map"></div>
</div>

{% block js %}
    <script src="{% static 'mapping/js/leaflet/leaflet.js' %}"></script>
    <script type="module" src="{% static 'mapping/js/mapping/plot_points.js' %}"></script>
    <script type="module">
        import { getAllPoints, getCountriesPolygonsWithACRecords } from "{% static 'mapping/js/ajax_calls/ajax_mapping.js' %}";
        import { createMap, addTile, addRecordsMarkers, createMarkerGroup } from "{% static 'mapping/js/mapping/plot_points.js' %}";
        import { createHeatmapLayer } from "{% static 'mapping/js/mapping/heat_map.js' %}";
        import { styleCountries } from "{% static 'mapping/js/mapping/country_polygons.js' %}";

        // create base map
        var baseMap = createMap('global-map', [25, 0], 1.8);

        // add openstreetmap layer
        addTile(baseMap);

         async function getPolygons() {
            try {
              let response = await getCountriesPolygonsWithACRecords();
              let countries_polygons = await response;
              return countries_polygons
            } catch(err) {
              if (err.response) {
                console.error('error: ', err.response.status);
              }
            }
          }

        let polygons;
        polygons = await getPolygons();
        const polygonLayer = L.geoJson(JSON.parse(polygons), {style: styleCountries});
        baseMap.addLayer(polygonLayer);
        
        // create legend
        const legend = L.control({ position: "bottomright" });

        legend.onAdd = function (map) {
          const div = L.DomUtil.create("div", "legend");
          div.innerHTML += "<h4>Crested Myna Distribution</h4>";
          div.innerHTML += '<div><span class="legend-box" style="background: #2E8B57"></span> Native Range</div>';
          div.innerHTML += '<div><span class="legend-box gradient-violet"></span> Exotic Range</div>';

          return div;
        };

        // Add the legend to the map
        legend.addTo(baseMap);

    </script>
{% endblock %}
