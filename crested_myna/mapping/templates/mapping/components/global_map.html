{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'mapping/css/leaflet/leaflet.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
{% endblock %}

<div class="container p-3">
    <div id="global-map" class="global-map"></div>
</div>

{% block js %}
    <script src="{% static 'mapping/js/leaflet/leaflet.js' %}"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script type="module" src="{% static 'mapping/js/mapping/plot_points.js' %}"></script>
    <script type="module">
        import { getAllPoints } from "{% static 'mapping/js/ajax_calls/ajax_mapping.js' %}";
        import { createMap, addTile, addRecordsMarkers, createMarkerGroup } from "{% static 'mapping/js/mapping/plot_points.js' %}";
        import { createHeatmapLayer } from "{% static 'mapping/js/mapping/heat_map.js' %}";

        // create base map
        var baseMap = createMap('global-map', [0, 0], 1.8);

        // add openstreetmap layer
        addTile(baseMap);

        // get geopoints cases from REST API
        async function getRecords() {
            console.log("entra get records funcion")
            try {
              let response = await getAllPoints();
              console.log("response in global map", response);
              let geopoints = await response;
              return geopoints
            } catch(err) {
              if (err.response) {
                console.error('error: ', err.response.status);
              }
            }
          }
        
          async function getPolygons() {
            console.log("entra get polygons funcion")
            try {
              let response = await getCountriesPolygonsWithACRecords();
              console.log("response contries", response);
              let countries_polygons = await response;
              return countries_polygons
            } catch(err) {
              if (err.response) {
                console.error('error: ', err.response.status);
              }
            }
          }
        records = await getRecords();
        createHeatmapLayer(records, baseMap);
        baseMap.setZoom(2, { animate: true }); 
        console.log("records in global map2", records);

    </script>
{% endblock %}
